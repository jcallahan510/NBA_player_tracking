---
title: "feature engineering"
output: html_document
---

```{r message=FALSE, warning=FALSE}

library(tidyverse)
library(janitor)
library(moderndive)
library(aspace)

options(scipen = 999)

`%not_in%` = Negate(`%in%`)

```

```{r message=FALSE, warning=FALSE}
shot_attempts_all_nearest_def <- read_csv("data/shot_attempts_all_nearest_def.csv")
```


```{r}
# shot_attempts_all_nearest_def <- shot_attempts_all_nearest_def %>% 
#   mutate(no_shooter_flag = case_when(shooter_id == p1_id ~ 1,
#                                      shooter_id == p2_id ~ 2,
#                                      shooter_id == p3_id ~ 3,
#                                      shooter_id == p4_id ~ 4,
#                                      shooter_id == p5_id ~ 5,
#                                      shooter_id == p6_id ~ 6,
#                                      shooter_id == p7_id ~ 7,
#                                      shooter_id == p8_id ~ 8,
#                                      shooter_id == p9_id ~ 19,
#                                      shooter_id == p10_id ~ 10,
#                                      TRUE ~ 0
#                                 )
#          ) %>% 
#   filter(no_shooter_flag != 0)
```




```{r functions}
def_angle <- function(x, y, x2, y2){
  nearest_def_dist <- sqrt(((x-x2)^2) + ((y-y2)^2))
  shot_dist_from_L_hoop <- sqrt(((x-5.35)^2) + ((y-25)^2))
  shot_dist_from_R_hoop <- sqrt(((x-88.65)^2) + ((y-25)^2))
  def_dist_from_L_hoop <- sqrt(((x2-5.35)^2) + ((y2-25)^2))
  def_dist_from_R_hoop <- sqrt(((x2-88.65)^2) + ((y2-25)^2))
  shooter_to_hoop <- ifelse(shot_dist_from_L_hoop < shot_dist_from_R_hoop, shot_dist_from_L_hoop, shot_dist_from_R_hoop)
  def_hoop <- ifelse(def_dist_from_L_hoop < def_dist_from_R_hoop, def_dist_from_L_hoop, def_dist_from_R_hoop)
  def_angle <- acos_d(((nearest_def_dist^2)+(shooter_to_hoop^2)-(def_hoop^2))/(2*nearest_def_dist*shooter_to_hoop))
  return(def_angle)
  }

shooter_to_hoop <- function(x, y){
  shot_dist_from_L_hoop <- sqrt(((x-5.35)^2) + ((y-25)^2))
  shot_dist_from_R_hoop <- sqrt(((x-88.65)^2) + ((y-25)^2))
  shooter_to_hoop <- ifelse(shot_dist_from_L_hoop < shot_dist_from_R_hoop, shot_dist_from_L_hoop, shot_dist_from_R_hoop)
  return(shooter_to_hoop)
  
}
```


```{r}
shot_attempts_final <- shot_attempts_all_nearest_def %>% 
  mutate(points = case_when(shot_type == "3PT Field Goal" & event_type == "Made Shot" ~ 3,
                            shot_type == "2PT Field Goal" & event_type == "Made Shot" ~ 2,
                            event_type == "Missed Shot" ~ 0
                            ),
         shot_type_num = ifelse(shot_type == "2PT Field Goal", 2, 3),
         shooter_to_hoop = shooter_to_hoop(shooter_x_loc, shooter_y_loc),
         nearest_def_dist = sqrt(((shooter_x_loc-nearest_def_x_loc)^2) + ((shooter_y_loc-nearest_def_y_loc)^2)),
         def_angle = def_angle(shooter_x_loc, shooter_y_loc, nearest_def_x_loc, nearest_def_y_loc)
         ) 


nan_def_angle <- shot_attempts_final %>%
  filter_all(any_vars(is.na(.))) %>% 
  select(shooter_x_loc, shooter_y_loc, shooter_id, nearest_def_dist, nearest_def_x_loc, nearest_def_y_loc, shot_team_id, p1_dist_from_ball:p10_dist_from_ball, p1_id:p10_y_loc, everything(), -1)

#write.csv(nan_def_angle, 'nan_def_angle.csv', )

shot_attempts_final %>% 
  arrange(-nearest_def_dist) %>% 
  select(shooter_x_loc, shooter_y_loc, shooter_id, nearest_def_dist, nearest_def_x_loc, nearest_def_y_loc, shot_team_id, p1_dist_from_ball:p10_dist_from_ball, p1_id:p10_y_loc, everything())


shot_attempts_final %>% 
  mutate(ball_to_shooter = sqrt(((shooter_x_loc-ball_x_loc)^2) + ((shooter_y_loc-ball_y_loc)^2))) %>% 
  arrange(-ball_to_shooter) %>% 
  select(ball_to_shooter, everything()) %>% 
  filter(ball_to_shooter > 10)

```


```{r}
shot_attempts_final <- shot_attempts_all_nearest_def %>% 
  mutate(case_when(shooter_id == p1_id ~ 1,
         shooter_id == p2_id ~ 2,
         shooter_id == p3_id ~ 3,
         shooter_id == p4_id ~ 4,
         shooter_id == p5_id ~ 5,
         shooter_id == p6_id ~ 6,
         shooter_id == p7_id ~ 7,
         shooter_id == p8_id ~ 8,
         shooter_id == p9_id ~ 19,
         shooter_id == p10_id ~ 10,
                                     TRUE ~ 0
                                )
```


```{r}


```

```{r}
shot_attempts_all %>% 
  filter(game_id == "0021500336", player_name == "Jae Crowder", quarter == 6)
```









```{r}

# shoot <- c(0, 2)
# basket <- c(0, 0)
# def <- c(2, 0)
# 
# a <- sqrt(((basket[1]-def[1])^2)+((basket[2]-def[2])^2)) #defender to hoop
# b <- sqrt(((shoot[1]-def[1])^2)+((shoot[2]-def[2])^2)) #neaest_def_distance
# c <- sqrt(((shoot[1]-basket[1])^2)+((shoot[2]-basket[2])^2)) #shooter to hoop
# 
# acos_d(((b^2)+(c^2)-(a^2))/(2*b*c))
```

